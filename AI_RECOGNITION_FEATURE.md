# 📸 AI智能识别功能 - 拍照添加商品

## 🎯 功能概述

将原有的"扫码添加"升级为"拍照添加"，通过AI LLM自动识别商品信息，大大提升用户体验。

### ✨ 核心流程

```
用户拍照 → 上传图片 → 后端LLM识别 → 自动填表 → 用户确认/修改 → 提交
```

## 📱 功能特性

### 1. 拍照界面
- **全屏相机体验** - 沉浸式拍照界面
- **实时预览** - 拍照后立即显示
- **支持相册选择** - 可从相册选择图片
- **高清拍摄** - 自动优化图片质量（最大1920px宽度）

### 2. AI智能识别
- **多维度识别**
  - 商品名称
  - 商品分类（乳制品、烘焙、生鲜等）
  - 品牌信息
  - 保质期计算（从生产日期+保质期推算剩余天数）
  - 自动匹配Emoji图标

- **智能保质期推断**
  - 识别生产日期
  - 读取保质期天数
  - 自动计算剩余天数

### 3. 表单自动填充
- **预填充所有字段** - 用户无需重复输入
- **允许用户修改** - 防止AI识别误差
- **实时编辑** - 所有字段可编辑
- **表单验证** - 确保数据完整性

### 4. 错误处理
- **网络超时检测** - 自动提示网络问题
- **识别失败处理** - 提供手动添加备选方案
- **用户友好提示** - 清晰的错误信息和操作建议

## 🔧 技术实现

### 新增文件

```
lib/
├── services/
│   └── ai_recognition_service.dart  # AI识别服务
└── screens/add/
    ├── add_select_screen.dart       # 更新选择页
    ├── camera_capture_screen.dart   # 新增拍照页
    └── manual_add_screen.dart       # 更新（支持预填充）
```

### 关键依赖

```yaml
dependencies:
  image_picker: ^1.0.4      # 拍照和选择图片
  dio: ^5.4.0               # HTTP请求库
```

## 🌐 后端API接口

### 请求格式
```
POST /api/recognize-product
Content-Type: multipart/form-data

Body:
  image: <商品图片文件>
```

### 响应格式
```json
{
  "result": {
    "name": "全脂牛奶",
    "category": "乳制品",
    "brand": "蒙牛",
    "days_left": 7,
    "shelf_life_days": 14,
    "description": "精选优质牧场奶源...",
    "confidence": 0.95,
    "production_date": "2024-11-01"
  }
}
```

### 必填字段
- `name` - 商品名称
- `category` - 商品分类
- `brand` - 品牌
- `shelf_life_days` - 保质期总天数

### 可选字段
- `days_left` - 直接提供剩余天数
- `production_date` - 生产日期（用于计算剩余天数）
- `description` - 商品描述
- `confidence` - 识别置信度（0-1）

## 📋 使用说明

### 开发者配置

1. **配置API地址**
   ```dart
   // lib/services/ai_recognition_service.dart:5
   static const String _baseUrl = 'https://your-api-server.com/api';
   ```

2. **更新端点**（如需要）
   ```dart
   static const String _recognizeEndpoint = '/recognize-product';
   ```

3. **处理权限**（Android/iOS）
   - Android: 自动处理
   - iOS: 在Info.plist中添加相机权限

### 用户使用流程

1. **进入添加页面**
   - 点击底部导航"新增"
   - 选择"拍照添加"

2. **拍照/选择图片**
   - 点击中央相机按钮拍照
   - 或点击"从相册选择"按钮

3. **等待AI识别**
   - 显示加载动画："AI正在识别商品信息..."
   - 通常需要2-5秒

4. **确认商品信息**
   - 检查AI识别的结果
   - 修改不准确的信息
   - 点击"添加商品"提交

## 🎨 UI设计亮点

### 拍照页面
- **黑色背景** - 突出相机预览
- **毛玻璃顶部栏** - 半透明效果
- **浮动拍照按钮** - 发光效果，吸引点击
- **渐变底部栏** - 引导用户操作

### 加载状态
- **环形进度条** - 品牌色
- **友好提示文字** - 减少等待焦虑
- **不阻塞UI** - 用户可随时取消

### 错误处理
- **SnackBar提示** - 快速反馈
- **弹窗确认** - 重要操作确认
- **备选方案** - 识别失败可手动添加

## ⚡ 性能优化

1. **图片压缩**
   - 自动压缩至80%质量
   - 最大宽度1920px
   - 减少上传时间和流量

2. **请求优化**
   - 30秒超时设置
   - 连接超时检测
   - 错误重试机制

3. **内存管理**
   - 及时释放图片资源
   - 组件dispose释放

## 🔐 安全考虑

1. **图片传输**
   - 使用HTTPS加密
   - FormData格式安全

2. **API安全**
   - 需要身份验证（建议）
   - 限流防护（建议）
   - 数据校验（后端）

3. **隐私保护**
   - 图片不上传至第三方存储
   - 仅用于识别目的
   - 可选择性删除（建议）

## 📊 识别准确率优化建议

### 拍摄建议
- 光线充足
- 商品平放
- 文字清晰可见
- 避免反光

### 后端优化
- 使用高精度模型（如GPT-4V、Claude-3）
- 多角度识别
- OCR辅助文字提取
- 保质期数据库匹配

## 🚀 扩展功能（未来）

1. **批量识别** - 一次拍多件商品
2. **智能分类** - 自动推荐分类
3. **条形码结合** - 扫码+拍照双重验证
4. **历史记录** - 识别历史查看
5. **用户反馈** - 标记识别错误，提升模型

## 🐛 已知问题

1. **模拟器测试**
   - 真机测试需要配置相机权限
   - 模拟器可能无法调用相机

2. **网络依赖**
   - 离线时功能不可用
   - 建议添加离线模式（简单识别）

3. **LLM成本**
   - 需要付费API调用
   - 建议监控使用量

## 📞 技术支持

如遇到问题，请检查：
1. 网络连接是否正常
2. 后端API是否可访问
3. 权限配置是否正确
4. 日志中的错误信息

---

**版本**: v2.0.0
**最后更新**: 2025-11-24
**开发者**: Claude Code
