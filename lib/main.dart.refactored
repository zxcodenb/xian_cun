import 'dart:ui';
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/services.dart';

// --- å…¥å£ ---
void main() {
  SystemChrome.setSystemUIOverlayStyle(const SystemUiOverlayStyle(
    statusBarColor: Colors.transparent,
    statusBarIconBrightness: Brightness.dark,
  ));
  runApp(const ApplePantryApp());
}

// --- ä¸»åº”ç”¨ ---
class ApplePantryApp extends StatelessWidget {
  const ApplePantryApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Apple Pantry',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        scaffoldBackgroundColor: const Color(0xFFF5F5F7),
        primaryColor: const Color(0xFF0A84FF),
        fontFamily: '.SF Pro Text',
        useMaterial3: true,
      ),
      home: const MainShell(),
    );
  }
}

// --- ä¸» Shell (åŒ…å«åº•éƒ¨å¯¼èˆª) ---
class MainShell extends StatefulWidget {
  const MainShell({super.key});

  @override
  State<MainShell> createState() => _MainShellState();
}

class _MainShellState extends State<MainShell> {
  int _currentIndex = 0;

  // ç»´æŠ¤å•†å“åˆ—è¡¨çŠ¶æ€
  final List<dynamic> _items = [];

  _MainShellState() {
    // åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®
    _items.addAll([
      {
        'id': 1,
        'name': 'å…¨è„‚ç‰›å¥¶',
        'category': 'ä¹³åˆ¶å“',
        'daysLeft': 2,
        'totalDays': 14,
        'emoji': 'ğŸ¥›',
        'purchaseDate': DateTime.now().subtract(const Duration(days: 12)),
        'brand': 'è’™ç‰›',
        'description': 'ç²¾é€‰ä¼˜è´¨ç‰§åœºå¥¶æºï¼Œå£æ„Ÿé†‡åšï¼Œè¥å…»ä¸°å¯Œã€‚é€‚åˆç›´æ¥é¥®ç”¨æˆ–åˆ¶ä½œå’–å•¡ã€éº¦ç‰‡ç­‰ã€‚',
      },
      {
        'id': 2,
        'name': 'æ³•å¼è½¯é¢åŒ…',
        'category': 'çƒ˜ç„™',
        'daysLeft': 12,
        'totalDays': 20,
        'emoji': 'ğŸ',
        'purchaseDate': DateTime.now().subtract(const Duration(days: 8)),
        'brand': 'å‘³å¤šç¾',
        'description': 'æ–°é²œå‡ºç‚‰çš„æ³•å¼è½¯é¢åŒ…ï¼Œæ¾è½¯é¦™ç”œï¼Œæ˜¯æ—©é¤çš„å®Œç¾é€‰æ‹©ã€‚',
      },
      {
        'id': 3,
        'name': 'ç‰›æ²¹æœ (3ä¸ª)',
        'category': 'ç”Ÿé²œ',
        'daysLeft': 4,
        'totalDays': 10,
        'emoji': 'ğŸ¥‘',
        'purchaseDate': DateTime.now().subtract(const Duration(days: 6)),
        'brand': 'è¿›å£ç²¾é€‰',
        'description': 'æ¥è‡ªå¢¨è¥¿å“¥çš„ä¼˜è´¨ç‰›æ²¹æœï¼Œå¯Œå«å¥åº·è„‚è‚ªå’Œç»´ç”Ÿç´ ï¼Œå£æ„Ÿç»µå¯†é¦™ç”œã€‚',
      },
      {
        'id': 4,
        'name': 'è‰è“æœé…±',
        'category': 'è°ƒå‘³',
        'daysLeft': 45,
        'totalDays': 180,
        'emoji': 'ğŸ“',
        'purchaseDate': DateTime.now().subtract(const Duration(days: 135)),
        'brand': 'å†œå¤«æœå›­',
        'description': '100%æ–°é²œè‰è“åˆ¶ä½œï¼Œæ— æ·»åŠ å‰‚ï¼Œå¯æ­é…åå¸ã€é…¸å¥¶é£Ÿç”¨ã€‚',
      },
      {
        'id': 5,
        'name': 'ä¸‰æ–‡é±¼åˆ‡ç‰‡',
        'category': 'å†·å†»',
        'daysLeft': 1,
        'totalDays': 7,
        'emoji': 'ğŸŸ',
        'purchaseDate': DateTime.now().subtract(const Duration(days: 6)),
        'brand': 'æŒªå¨æµ·äº§',
        'description': 'æ–°é²œä¸‰æ–‡é±¼åˆ‡ç‰‡ï¼Œè‚‰è´¨é²œç¾ï¼Œå¯Œå«Omega-3è„‚è‚ªé…¸ã€‚æ¨èç”Ÿé£Ÿæˆ–è½»ç…ã€‚',
      },
    ]);
  }

  // å¤„ç†æ·»åŠ å•†å“
  void _handleAddItem(Map<String, dynamic> item) {
    setState(() {
      _items.insert(0, item);
      _currentIndex = 0; // è¿”å›é¦–é¡µ
    });
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('å·²æ·»åŠ : ${item['name']}')),
    );
  }

  // æä¾›ç»™Dashboardçš„æ·»åŠ æ–¹æ³•
  void addItem(Map<String, dynamic> item) {
    _handleAddItem(item);
  }

  @override
  Widget build(BuildContext context) {
    final List<Widget> _pages = [
      const DashboardScreen(),
      AddSelectScreen(
        onScanComplete: _handleAddItem,
        onManualAddComplete: _handleAddItem,
      ),
      const SettingsScreen(),
    ];

    return Scaffold(
      body: IndexedStack(
        index: _currentIndex,
        children: _pages,
      ),
      bottomNavigationBar: Container(
        height: 84,
        padding: const EdgeInsets.only(bottom: 20),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(0),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.05),
              blurRadius: 10,
              offset: const Offset(0, -4),
            ),
          ],
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceAround,
          children: [
            NavItem(
              icon: CupertinoIcons.home,
              label: 'é¦–é¡µ',
              isActive: _currentIndex == 0,
              onTap: () => setState(() => _currentIndex = 0),
            ),
            NavItem(
              icon: CupertinoIcons.add,
              label: 'æ–°å¢',
              isActive: _currentIndex == 1,
              onTap: () => setState(() => _currentIndex = 1),
            ),
            NavItem(
              icon: CupertinoIcons.settings,
              label: 'è®¾ç½®',
              isActive: _currentIndex == 2,
              onTap: () => setState(() => _currentIndex = 2),
            ),
          ],
        ),
      ),
    );
  }
}
